<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp Web Clone</title>
  <link rel="stylesheet" href="styles.css" />

</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="chat-footer">
        <h1 style="display: inline;">Chats</h1>
        <button id="open-modal" style="margin-left: 290px;width: 30px;height: 30px;border: 4px solid #007bff;">
          <img src="pics/icons8-plus-math-20.png" alt="Send" class="icon" />
        </button>
        <button id="open-settings" style="background:white;width: 30px;height: 30px;  border: 3.5px solid #007bff; right:0">
        <img src="pics/3dotblue.png" alt="Send" class="icon" />
         </button>

      </div>

      <input type="text" placeholder="Search" />
      <!-- Chat list will be injected here -->


   <!-- Chat list gets replaced here -->
<div id="chat-placeholder">
  <div class="chat" onclick="openChat('Umer')">
    <img src="pics/def.jpeg" alt="User" />
    <div>
      <h3>Umer</h3>
      <p>What's going on?</p>
    </div>
    <span>01:00 PM</span>
  </div>
  <div class="chat" onclick="openChat('Ali')">
    <img src="pics/def.jpeg" alt="User" />
    <div>
      <h3>Ali</h3>
      <p>hello</p>
    </div>
    <span>12:20 PM</span>
  </div>
</div>

    </div>

    <!-- Chat Window -->
    <div class="chat-window">
     <div class="chat-header">
  <img src="pics/def.jpeg" alt="User" />
  <div class="user-details">
    <h3 id="chat-name">None</h3>
    <div id="chat-status">
      <span class="status-dot">‚óè</span>
      <span class="status-text">Checking...</span>
    </div>
  </div>
</div>

      <div class="messages">
        <div class="message sent">Hello! how are you?<span>12:34</span></div>
        <div class="message received">I'm good, thanks!<span>12:35</span></div>
        <div class="media">
          <img src="pics/uni.jpeg" alt="Video" />
          <audio controls>
            <source src="pics/admin1_20250623_105804.webm" type="audio/mpeg" />
          </audio>
        </div>
      </div>
      <div class="chat-footer">
    <input type="file" id="fileInput" style="display: none" />
  <button id="fileBtn" style="background:white;">
  <img src="pics/ios-30 (1).png" alt="Emoji" class="icon" />
  </button>

  <input type="text" id="message-input" placeholder="Type a message..." />

  <button id="micBtn" style="background:rgba(255, 255, 255, 0);">
  <img src="pics/icons8-microphone-30.png" alt="Mic" class="icon" />
  </button>

 <button id="send-message-button">
  <img src="pics/arrowup.png" alt="">
 </button>
  
  
  </div>

    </div>








  </div>

  <!-- New contact Modal -->
  <div class="modal" id="new-contact-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>New Contact</h2>
        <button class="close-btn" id="close-contact-modal">&times;</button>
      </div>

      <div class="modal-search">
        <input type="text" placeholder="Search for username" />
      </div>

      <div class="modal-body">
        <div class="section-title">Users available on Aura+</div>
        <ul class="user-list">
          <!-- Repeat user item -->
          <li class="user-item">
            <img src="https://ui-avatars.com/api/?name=John+Doe&background=007bff&color=fff" alt="John Doe" />
            <div class="user-info">
              <h3>John Doe</h3>
              <p>@johndoe</p>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" />
            </div>
          </li>
          <!-- You can duplicate and change names/colors for more users -->
        </ul>
      </div>

      <div class="modal-footer">
        <button id="new-group-modal-button">Create Group</button>
      </div>
    </div>
  </div>

<!-- Modal -->
<div class="modal" id="new-group-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title">New Group</h2>
      <button class="close-btn" id="close-group-modal">&times;</button>
    </div>

    <div class="modal-search">
      <input type="text" placeholder="Search for username" />
    </div>

    <div class="modal-body">
        <div style="margin-bottom: 15px;">
  
  <input id="group-name" type="text" placeholder="Enter Group name" style="width: 88%; padding: 10px; border-radius: 20px; border: 1px solid #ccc; margin-top: 5px;margin-left: 20px;">
</div>
      <div class="section-title">Users available on Aura+</div>
      <ul class="user-list">
        <li class="user-item">
          <img src="https://ui-avatars.com/api/?name=John+Doe&background=007bff&color=fff" alt="John Doe" />
          <div class="user-info">
            <h3>John Doe</h3>
            <p>@johndoe</p>
          </div>
          <div class="checkbox-container">
            <input type="checkbox" class="user-checkbox" />
          </div>
        </li>
        <!-- Duplicate for more users -->
      </ul>
    </div>

    <div class="modal-footer">
      <button id="switch-to-group" onclick="createGroup()">Create Group</button>
    </div>
  </div>
</div>
<!-- Profile  -->

<div class="modal" id="profile-mangment" >
  <div class="modal-content">
    <div class="modal-header">
      <h2>Settings</h2>
      <button class="close-btn" id="close-settings-modal">&times;</button>
    </div>

    <div class="modal-body">
      <div style="padding: 20px;">
        <div onclick="opensettings()" id="profile-card" style="display: flex; align-items: center; background: #f9f9f9; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
  <img id="profile-img" src="pics/def.jpeg" style="width: 60px; height: 60px; border-radius: 50%; margin-right: 15px;" />
  <div>
    <h3 id="profile-name" style="margin: 0; font-size: 18px; color: #3b4a54;">Loading...</h3>
    <p id="profile-username" style="margin: 2px 0 0 0; color: gray;">@username</p>
  </div>
        </div>

        <div style="font-size: 12px; color: gray; text-transform: uppercase; margin-bottom: 8px;">Account</div>

        <div style="border-radius: 12px; overflow: hidden; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
          <div onclick="openChangePasswordModal()" style="display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #eee; cursor: pointer;">
            <img src="pics/key.png" style="width: 24px; height: 24px; background: green; border-radius: 6px; padding: 4px; margin-right: 12px;" />
            <span style="flex-grow: 1; font-weight: 500;">Account</span>
          </div>
          <div style="display: flex; align-items: center; padding: 12px 16px; cursor: pointer;">
            <img src="pics/icons8-warning-sign-66.png" style="width: 24px; height: 24px; background: red; border-radius: 6px; padding: 4px; margin-right: 12px;" />
            <span style="flex-grow: 1; font-weight: 500;">Logout</span>
          </div>
        </div>

      </div>
    </div>
  </div>
<!-- Profile 1  -->
<!-- Settings Edit Modal -->
<div class="modal" id="profile-management-1">
  <div class="modal-content" style="padding: 20px;">
    <div class="modal-header" style="border-bottom: none;">
      <h2>Settings</h2>
      <button class="close-btn" id="profile-management-1-close">&times;</button>
    </div>
    
    <div style="background: #fff; padding: 20px; border-radius: 16px;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <img id="preview-img" src="pics/def.jpeg" alt="Profile" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
        <div>
          <p style="margin: 0; font-size: 15px;">Edit your name and add an optional profile picture</p>
          <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="submitProfileUpdatePhoto(event)" />

          <button onclick="document.getElementById('imageUpload').click()" style="background: none; border: none; color: #007bff; font-weight: 500; padding: 0; cursor: pointer;">Edit</button>
        </div>
      </div>

      <div style="margin-top: 25px;">
        <input id="nameInput" type="text" placeholder="    Enter your name" style=" width: 100%;
    max-width: 400px;
    padding: 10px 15px 10px 40px;
    border: 1px solid #ddd;
    border-radius: 25px;
    color: #3b4a54;
    font-size: 14px;
    outline: none;">
      </div>

      <div style="margin-top: 25px;">
        <button id="confirmProfileUpdate" style="width: 100%; padding: 12px 0; border: none; border-radius: 12px; background: #007bff; color: white; font-size: 16px; font-weight: 500; cursor: pointer;">Confirm</button>
      </div>
    </div>
  </div>
</div>


<!-- Change Password Modal -->
<div class="modal" id="change-password-modal">
  <div class="modal-content" style="padding: 20px;">
    <div class="modal-header" style="border-bottom: none;">
      <h2>Change your Password</h2>
      <button class="close-btn" id="close-password-modal">&times;</button>
    </div>

    <p style="margin-top: -10px; font-size: 14px;">Make sure your password is strong and unique.</p>

    <div style="margin-top: 20px;">
      <label style="font-weight: bold;">Password</label>
      <input type="password" id="old-password" placeholder="Enter your old password" style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc;">
    </div>

    <div style="margin-top: 15px;">
      <label style="font-weight: bold;">New Password</label>
      <input type="password" id="new-password" placeholder="Enter new password" style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc;">
    </div>

    <div style="margin-top: 15px;">
      <label style="font-weight: bold;">Confirm Password</label>
      <input type="password" id="confirm-password" placeholder="Confirm new password" style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc;">
    </div>

    <div style="margin-top: 25px;">
      <button id="submit-password-change" style="width: 100%; padding: 12px 0; border: none; border-radius: 12px; background: #007bff; color: white; font-size: 16px; font-weight: 500; cursor: pointer;">Change Password</button>
    </div>
  </div>
</div>







  <!-- JavaScript -->
  <script>

function openChangePasswordModal() {
  document.getElementById("change-password-modal").style.display = "flex";
}   
// Close modal change password
document.getElementById("close-password-modal").addEventListener("click", function () {
  document.getElementById("change-password-modal").style.display = "none";
});

  function opensettings() {
     document.getElementById('profile-management-1').style.display='flex';
     loadProfileCard()
     
     //document.getElementById("profile-mangment").style.display = "none";
    }
let statusInterval = null;

function openChat(name, chatid,picture) {
  currentChatId = chatid;
  currentGroupId = null;

  document.getElementById("chat-name").textContent = name;
  document.querySelector(".chat-header img").src = picture;

  loadChatMessages(chatid, sessionStorage.getItem("user_id"));
//aadd here picture

  // Prevent adding multiple input listeners
  const inputBox = document.getElementById("message-input");
  inputBox.removeEventListener("input", inputBox._listener);
  inputBox._listener = () => {
    updateTypingStatus(currentChatId, sessionStorage.getItem("user_id"), true);

    clearTimeout(window.typingTimeout);
    window.typingTimeout = setTimeout(() => {
      updateTypingStatus(currentChatId, sessionStorage.getItem("user_id"), false);
    }, 2000);
  };
  inputBox.addEventListener("input", inputBox._listener);

  // Try to find the corresponding chat div
 const chatDiv = Array.from(document.getElementsByClassName("chat"))
  .find(div => div.dataset.username === name);

  if (!chatDiv) {
    console.warn(`‚ö†Ô∏è chatDiv not found for name: ${name}`);
    return;
  }

  const otherUsername = chatDiv.dataset.username;
  if (!otherUsername) {
    console.warn("‚ö†Ô∏è No data-username on chatDiv");
    return;
  }

  console.log("‚úÖ Checking online status for", otherUsername);

  // Clear previous interval
  if (statusInterval) clearInterval(statusInterval);
  statusInterval = setInterval(() => {
    updateHeaderStatus(otherUsername);
  }, 2000);
  updateHeaderStatus(otherUsername);

  // Close previous socket if open
  if (chatSocket) chatSocket.close();

  chatSocket = new WebSocket("ws://192.168.100.29:8888/ws/chat");

  chatSocket.onopen = () => console.log("‚úÖ WebSocket connected");

  chatSocket.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.chat_id !== currentChatId) return;

    const container = document.querySelector(".messages");
    container.innerHTML += renderSingleMessage(msg, sessionStorage.getItem("user_id"));
  };

  chatSocket.onerror = (e) => console.error("‚ùå WebSocket error", e);
  chatSocket.onclose = () => console.log("WebSocket closed");
}



function updateHeaderGroupName(groupName) {
  const headerName = document.getElementById("chat-name");
  const statusText = document.querySelector("#chat-status .status-text");
  const statusDot = document.querySelector("#chat-status .status-dot");

  if (headerName) headerName.textContent = groupName;

  if (statusText) statusText.textContent = "Group"; // Clear text
  if (statusDot) statusDot.style.display = "none"; // Hide the dot
}
 

    // Modal Show/Hide Logic
  document.getElementById("open-modal").addEventListener("click", function () {
  document.getElementById("new-contact-modal").style.display = "flex"; // ‚úÖ change to flex when opening
  loadContacts();
});


    document.getElementById("close-contact-modal").addEventListener("click", function () {
      document.getElementById("new-contact-modal").style.display = "none";
    });


   // Modal Show/Hide Logic
  document.getElementById("new-group-modal-button").addEventListener("click", function () {
  document.getElementById("new-group-modal").style.display = "flex"; // ‚úÖ change to flex when opening
  document.getElementById("new-contact-modal").style.display = "none";
  loadGroupContacts(); 

});

    document.getElementById("close-group-modal").addEventListener("click", function () {
      document.getElementById("new-group-modal").style.display = "none";
    });





document.getElementById("open-settings").addEventListener("click", () => {
  document.getElementById("profile-mangment").style.display = "flex";
  loadProfileCard();
});




    document.getElementById("close-settings-modal").addEventListener("click", () => {
      document.getElementById("profile-mangment").style.display = "none";
    });
//Call it when tab/window is closedlet isClosing = true;

window.addEventListener("beforeunload", (e) => {
  if (isClosing) {
    const username = sessionStorage.getItem("username");
    if (username) {
      const url = "http://192.168.100.29:8888/update-online-status";
      const data = JSON.stringify({ username, is_online: false });

      navigator.sendBeacon(url, new Blob([data], { type: "application/json" }));
    }
  }
});

// Set to false if page is being reloaded or navigated away
window.addEventListener("click", () => isClosing = false);
window.addEventListener("keydown", () => isClosing = false);
window.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "hidden") {
    isClosing = true;
  }
});

// Optional: detect reload
window.addEventListener("beforeunload", () => {
  if (performance.getEntriesByType("navigation")[0].type === "reload") {
    isClosing = false;
  }
});


    // Optional: Close modal if clicked outside modal content
   window.onclick = function (event) {
  const modals = document.querySelectorAll(".modal");
  modals.forEach(modal => {
    if (event.target === modal) {
      modal.style.display = "none";
    }
  });
};

document.getElementById("profile-management-1-close").addEventListener("click", function () {
  document.getElementById("profile-management-1").style.display = "none";
});
document.getElementById("submit-password-change").addEventListener("click", function () {
  changePassword();
});
  </script>



<script>
const API_URL_CHATS = "http://192.168.100.29:8888/get_user_chats";
async function changePassword() {
  const username = sessionStorage.getItem("username"); // Ensure username is saved in session
  const oldPassword = document.getElementById("old-password").value.trim();
  const newPassword = document.getElementById("new-password").value.trim();
  const confirmPassword = document.getElementById("confirm-password").value.trim();

  // ‚úÖ Basic validation
  if (!oldPassword || !newPassword || !confirmPassword) {
    alert("‚ö†Ô∏è Please fill in all fields.");
    return;
  }

  if (newPassword !== confirmPassword) {
    alert("‚ùå New password and confirm password do not match.");
    return;
  }

  try {
    const response = await fetch("http://192.168.100.29:8888/update_password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username,
        old_password: oldPassword,
        new_password: newPassword
      })
    });

    const result = await response.json();

    if (!response.ok) throw new Error(result.detail || "Failed to update password.");

    alert("‚úÖ Password changed successfully!");
    document.getElementById("change-password-modal").style.display = "none";

    // Optionally clear fields
    document.getElementById("old-password").value = "";
    document.getElementById("new-password").value = "";
    document.getElementById("confirm-password").value = "";

  } catch (error) {
    console.error("‚ùå Error changing password:", error);
    alert("Error: " + error.message);
  }
}


async function loadChats() {
  const username = sessionStorage.getItem("username");
  const userId = parseInt(sessionStorage.getItem("user_id")); // ‚úÖ needed for creator check

  if (!username) {
    alert("‚ö†Ô∏è User not logged in.");
    window.location.href = "index.html";
    return;
  }

  const chatList = document.getElementById("chat-placeholder");
  chatList.innerHTML = ""; // Clear existing

  try {
    // === 1. Fetch 1-on-1 chats ===
    const res = await fetch(API_URL_CHATS, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    if (!res.ok) throw new Error("Failed to fetch chats");

    const chats = await res.json();
    console.log("‚úÖ Direct chats:", chats);

    if (chats.length) {
      chats.forEach(chat => {
        const chatDiv = document.createElement("div");
        chatDiv.className = "chat";

        const chatId = parseInt(chat.chat_id);
        chatDiv.onclick = () => openChat(chat.with_username, chatId, chat.profile_picture_base64);

        const imgSrc = chat.profile_picture_base64 || 'pics/def.jpeg';
        
        let timeText = "";
        if (chat.last_message_time) {
          const dt = new Date(chat.last_message_time);
          timeText = dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        const lastMsg = chat.last_message === "Media" ? "Media" : decrypt(chat.last_message) || "";

        chatDiv.innerHTML = `
          <img src="${imgSrc}" alt="User" />
          <div>
            <h3>${chat.name}</h3>
            <p>${lastMsg}</p>
          </div>
          <span>${timeText}</span>
        `;

        chatDiv.dataset.chatId = chat.chat_id;
        chatDiv.dataset.userId = chat.with_user_id;
        chatDiv.dataset.username = chat.with_username;

        chatList.appendChild(chatDiv);
      });
    }

    console.log("‚úÖ Simple chats loaded");

    // === 2. Fetch group chats ===
    const groupRes = await fetch("http://192.168.100.29:8888/get_user_groups", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    if (!groupRes.ok) throw new Error("Failed to fetch group chats");

    const groups = await groupRes.json();
    console.log("‚úÖ Group chats:", groups);

    if (groups.length) {
      groups.forEach(group => {
  const groupDiv = document.createElement("div");
  groupDiv.className = "chat";

  const userId = parseInt(sessionStorage.getItem("user_id")); // ‚úÖ always use current user

  let timeText = "";
  if (group.last_time) {
    const dt = new Date(group.last_time);
    timeText = dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  const lastMsg1 = group.last_message === "Media" ? "Media" : decrypt(group.last_message) || "";

  groupDiv.innerHTML = `
    <img src="pics/def.jpeg" alt="Group" />
    <div>
      <h3>${group.group_name}</h3>
      <p>${lastMsg1}</p>
    </div>
    <span>${timeText}</span>
    <button class="delete-btn" onclick="event.stopPropagation(); deleteGroup(${group.group_id}, ${userId})">üóëÔ∏è</button>
  `;

  groupDiv.dataset.groupId = group.group_id;
  groupDiv.dataset.groupName = group.group_name;

  groupDiv.onclick = () => openGroupChat(group.group_name, group.group_id);

  chatList.appendChild(groupDiv);
});

    }

    // === 3. If no chats at all ===
    if (chats.length === 0 && groups.length === 0) {
      chatList.innerHTML = "<p style='padding: 20px;'>No chats available.</p>";
    }

  } catch (err) {
    console.error("‚ùå Error loading chats:", err);
    alert("Could not load chats.");
  }
}

async function loadProfileCard() {

  const username = sessionStorage.getItem("username") || "atif"; // fallback for testing

  try {
    const res = await fetch("http://192.168.100.29:8888/get-user-photo", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    if (!res.ok) throw new Error("User not found or no image");

    const data = await res.json();

    // Update profile name and username
    sessionStorage.setItem("name", data.name);
    document.getElementById("profile-name").textContent = data.name;
    document.getElementById("profile-username").textContent = `@${data.username}`;

    // If profile image exists, show it
    if (data.profile_image) {
      document.getElementById("profile-img").src = `data:image/png;base64,${data.profile_image}`;
       sessionStorage.setItem("profile_image", data.profile_image);
    }

  } catch (err) {
    console.warn("‚ö†Ô∏è Could not load profile info:", err);
    document.getElementById("profile-name").textContent = username;
    document.getElementById("profile-username").textContent = `@${username}`;
  }
}
async function submitProfileUpdatePhoto(event) {
  const username = sessionStorage.getItem("username") || "atif"; // replace fallback if needed
  const name = sessionStorage.getItem("name");
 
  const file = event.target.files[0];

  if (!name) {
    
    return;
  }

  if (!file) {
    alert("Please select an image to upload.");
    return;
  }

  try {
    const base64Image = await toBase64(file);

    const res = await fetch("http://192.168.100.29:8888/update-user-photo", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username,
        name,
        profile_image: base64Image.split(",")[1] // remove prefix
      })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Update failed");

    alert("‚úÖ Profile updated successfully.");
    closeEditProfileModal();
    loadProfileCard(); // reload updated info

  } catch (err) {
    console.error("‚ùå Error updating profile:", err);
    alert("Failed to update profile. Try again.");
  }
}

async function handleContactClick(contactUsername) {
  const username = sessionStorage.getItem("username");

  if (!username || !contactUsername || username === contactUsername) {
    alert("‚ùå Invalid contact selection.");
    return;
  }

  try {
    const res = await fetch("http://192.168.100.29:8888/create_or_get_chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username1: username,
        username2: contactUsername
      })
    });

    const data = await res.json();

    if (!res.ok) throw new Error(data.detail || "Failed to create or get chat");

    alert(`‚úÖ Chat ${data.status} (ID: ${data.chat_id})`);
    loadChats(); // Refresh the chat list

  } catch (err) {
    console.error("‚ùå Chat creation error:", err);
    alert("Error creating or getting chat: " + err.message);
  }
}

async function createGroup() {
  const creator = sessionStorage.getItem("username");
  const groupName = document.getElementById("group-name").value.trim();

  // Gather selected users
  const selectedCheckboxes = document.querySelectorAll('#new-group-modal .user-checkbox:checked');
  const selectedUsernames = Array.from(selectedCheckboxes).map(cb => cb.dataset.username);

  // Validation
  if (!groupName) {
    alert("‚ö†Ô∏è Please enter a group name.");
    return;
  }

  if (selectedUsernames.length < 2 || selectedUsernames.length > 5) {
    alert("‚ùå Group must have between 3 and 6 total members including you.");
    return;
  }

  try {
    const res = await fetch("http://192.168.100.29:8888/create_group", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        creator_username: creator,
        group_name: groupName,
        members: selectedUsernames
      })
    });

    const result = await res.json();
    if (!res.ok) throw new Error(result.detail || "Failed to create group");

    alert("‚úÖ Group created successfully!");
    document.getElementById("new-group-modal").style.display = "none";
    loadChats(); // Refresh chat list

  } catch (err) {
    console.error("‚ùå Error creating group:", err);
    alert("Error: " + err.message);
  }
}
async function updateOnlineStatus(isOnline) {
  const username = sessionStorage.getItem("username");
  if (!username) return;
  console.log(isOnline);

  try {
    await fetch("http://192.168.100.29:8888/update-online-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: username,
        is_online: isOnline
      })
    });
    console.log(`‚ÑπÔ∏è Status updated to ${isOnline ? 'online' : 'offline'}`);
  } catch (err) {
    console.warn("‚ö†Ô∏è Could not update online status:", err);
  }
}
async function updateHeaderStatus(username) {
  try {
    const res = await fetch("http://192.168.100.29:8888/get-online-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Failed");
    

    let statusText = data.is_online ? "Online" : "Offline";
    let statusColor = data.is_online ? "green" : "gray";
    console.log("Header status check " + data.is_online);

    // If online, check typing status in a nested try block
    if (data.is_online) {
      try {
        console.log("Checking typing status " + currentChatId + " " + username);

        const typingRes = await fetch(`http://192.168.100.29:8888/typing-status/${currentChatId}/${username}`);

        const typingData = await typingRes.json();

        if (typingRes.ok && typingData.is_typing) {
          statusText = "Typing...";
          statusColor = "blue";
        }

      } catch (typingErr) {
        console.error("‚ùå Typing status error:", typingErr);
      }
    }

    // Update dot color
    const dot = document.querySelector("#chat-status .status-dot");
    if (dot) {
      dot.style.color = statusColor;
      dot.style.display = "inline";
    }

    // Update status text
    const text = document.querySelector("#chat-status .status-text");
    if (text) text.textContent = statusText;

  } catch (err) {
    console.error("‚ùå Cannot fetch online status:", err);
  }
}




function openGroupChat(groupName, groupId) {
  currentGroupId = groupId;
  currentChatId = null;
  sessionStorage.setItem("currentGroup", groupId);
  updateHeaderGroupName(groupName);
console.log("open Group chat");
  // Clear messages and load group history
  const container = document.querySelector(".messages");
  container.innerHTML = "";

  fetch(`http://192.168.100.29:8888/group_messages/${groupId}`)
    .then(res => res.json())
    .then(messages => {
      let html = "";
      messages.forEach(msg => {
        html += renderSingleMessage(msg, sessionStorage.getItem("user_id"), true);
      });
      container.innerHTML = html;
    })
    .catch(err => console.error("‚ùå Group fetch failed", err));

  openGroupChatSocket(groupId); // Connect group WebSocket
}

async function updateTypingStatus(chatId, userId, isTyping) {
  try {
    console.log("Updating status"+isTyping);
    const res = await fetch("http://192.168.100.29:8888/update-typing-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        chat_id: chatId,
        user_id: userId,
        is_typing: isTyping
      })
    });

    const data = await res.json();

    if (!res.ok) throw new Error(data.detail || "Failed to update typing status");

    console.log("‚úÖ Typing status updated:", data.message);
  } catch (err) {
    console.error("‚ùå Error updating typing status:", err);
  }
}








// Convert image file to base64 string
function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
    reader.readAsDataURL(file);
  });
}


// Load on window ready
window.onload = loadChats;
</script>
<script>
const API_URL_USERS = "http://192.168.100.29:8888/get-users";

async function loadContacts() {
  const username = sessionStorage.getItem("username"); // Replace with sessionStorage.getItem("username") if needed

  try {
    const res = await fetch(API_URL_USERS, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    if (!res.ok) throw new Error("Failed to fetch users");

    const { users } = await res.json();
    console.log("üì¶ Users fetched:", users);

    const userList = document.querySelector("#new-contact-modal .user-list");
    userList.innerHTML = ""; // Clear existing items

    users.forEach(user => {
      const li = document.createElement("li");
      li.className = "user-item";

      const imgSrc = user.profile_image
        ? `data:image/png;base64,${user.profile_image}`
        : "pics/def.jpeg";

      li.innerHTML = `
        <img src="${imgSrc}" alt="${user.name}" />
        <div class="user-info">
          <h3>${user.name}</h3>
          <p>@${user.username}</p>
        </div>
        <div class="checkbox-container">
    <input type="checkbox" onchange="handleContactClick('${user.username}')" />
  </div>
      `;

      userList.appendChild(li);
    });

  } catch (err) {
    console.error("‚ùå Error fetching contacts:", err);
    alert("Could not load contacts.");
  }
}





</script>
<script>
async function loadGroupContacts() {
  const username = sessionStorage.getItem("username"); // Or use sessionStorage.getItem("username")

  try {
    const res = await fetch("http://192.168.100.29:8888/get-users", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    if (!res.ok) throw new Error("Failed to fetch users");

    const { users } = await res.json();
    console.log("üì¶ Group users fetched:", users);

    const groupList = document.querySelector("#new-group-modal .user-list");
    groupList.innerHTML = ""; // Clear previous

    users.forEach(user => {
      const li = document.createElement("li");
      li.className = "user-item";

      const imgSrc = user.profile_image
        ? `data:image/png;base64,${user.profile_image}`
        : "pics/def.jpeg";

      li.innerHTML = `
        <img src="${imgSrc}" alt="${user.name}" />
        <div class="user-info">
          <h3>${user.name}</h3>
          <p>@${user.username}</p>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" class="user-checkbox" data-username="${user.username}" />
        </div>
      `;

      groupList.appendChild(li);
    });

  } catch (err) {
    console.error("‚ùå Error fetching group contacts:", err);
    alert("Could not load group contacts.");
  }
}
</script>
<script>
let selectedImageBase64 = null; // Global variable

// When file is selected
document.getElementById("imageUpload").addEventListener("change", async function (event) {
  const file = event.target.files[0];
  if (!file) return;

  const base64 = await toBase64(file);
  selectedImageBase64 = base64.split(",")[1]; // remove data:image/png;base64, part

  // Preview the image
  document.getElementById("preview-img").src = base64;
});

// Convert file to base64
function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Confirm click handler
document.getElementById("confirmProfileUpdate").addEventListener("click", async function () {
  const username = sessionStorage.getItem("username") || "guest";
  let name = document.getElementById("nameInput").value.trim();

  // Use old name from session if input is empty
  if (!name) name = sessionStorage.getItem("name") || username;

  try {
    const payload = {
      username,
      name,
      profile_image: selectedImageBase64 // can be null
    };

    const res = await fetch("http://192.168.100.29:8888/update-user-photo", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Failed to update profile");

    alert("‚úÖ Profile updated.");
    sessionStorage.setItem("name", name);
    if (selectedImageBase64) sessionStorage.setItem("profile_image", selectedImageBase64);

    loadProfileCard(); // reload updated profile
    document.getElementById("profile-management-1").style.display = "none";

  } catch (err) {
    console.error("‚ùå Update error:", err);
    alert("Error: " + err.message);
  }
});
</script>

<script>async function loadChatMessages(chatId, currentUserId, isGroup = false) {
  try {
    console.log("üë§ User:", currentUserId, "| üì• Chat ID:", chatId);

    const res = await fetch(`http://192.168.100.29:8888/messages/${chatId}`);
    if (!res.ok) throw new Error("Network response was not ok");

    const messages = await res.json();
    const container = document.querySelector(".messages");
    container.innerHTML = ""; // Clear old messages

    if (messages.length === 0) {
      console.log("‚ÑπÔ∏è No messages found for this chat.");
      return;
    }

    // Use renderSingleMessage for each
    let allMessagesHTML = "";
    messages.forEach(msg => {
      allMessagesHTML += renderSingleMessage(msg, currentUserId, isGroup);
    });

    container.innerHTML = allMessagesHTML;
  } catch (err) {
    console.error("‚ùå Failed to load messages:", err);
  }
}

function escapeHtml(text) {
  return text.replace(/[&<>"']/g, m => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  })[m]);
}

// Helper to convert ISO time to readable time
function formatTime(isoString) {
  const date = new Date(isoString);
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function renderSingleMessage(msg, currentUserId, isGroup = false) {
  const isSent = parseInt(msg.sender_id) === parseInt(currentUserId);
  const time = new Date(msg.time_stamp).toLocaleTimeString([], {
    hour: '2-digit',
    minute: '2-digit'
  });

  const baseMediaUrl = "http://192.168.100.29:8888/get-media/?link=";
  const senderLabel = isGroup && !isSent ? `<strong style="color:#333">${msg.username}</strong><br/>` : "";

  let deleteBtn = "";
  if (isSent) {
    if (!isGroup) {
      deleteBtn = `<button class="delete-btn" onclick="deleteMessage(${msg.id}, ${currentUserId})">üóëÔ∏è</button>`;
    } else {
      deleteBtn = `<button class="delete-btn" onclick="deleteGroupMessage(${msg.id}, ${msg.sender_id})">üóëÔ∏è</button>`;
    }
  }

  if (msg.message_type === "text") {
    const decryption = decrypt(msg.content || msg.context); // for group msg use msg.context
    return `
      <div class="message ${isSent ? "sent" : "received"}" id="message-${msg.id}">
        ${deleteBtn}
        ${senderLabel}${escapeHtml(decryption)}<span>${time}</span>
      </div>
    `;
  }

  if (msg.message_type === "photo") {
    const imageUrl = baseMediaUrl + msg.media_url;
    return `
      <div class="message" id="message-${msg.id}" style="align-self:${isSent ? "flex-end" : "flex-start"};">
        <div class="media">
          ${deleteBtn}
          ${senderLabel}
          <img src="${imageUrl}" alt="Image" />
          <span style="color:black">${time}</span>
        </div>
      </div>
    `;
  }

  if (msg.message_type === "audio") {
    const audioUrl = baseMediaUrl + msg.media_url.replace(/\.[^/.]+$/, ".webm");
    return `
      <div class="message ${isSent ? "sent" : "received"}" id="message-${msg.id}" style="background: white;">
        ${deleteBtn}
        ${senderLabel}
        <audio controls src="${audioUrl}" style="background-color:${isSent ? "#007bff" : "#e0e0e0"};
          border-radius: 50px;
          padding: 3px;">
        </audio>
        <span style="color:black">${time}</span>
      </div>
    `;
  }

  if (msg.message_type === "video") {
    const videoUrl = baseMediaUrl + msg.media_url;
    return `
      <div class="message ${isSent ? "sent" : "received"}" id="message-${msg.id}">
        ${deleteBtn}
        ${senderLabel}
        <video controls width="250" style="border-radius: 8px;">
          <source src="${videoUrl}" type="video/webm">
          Your browser does not support the video tag.
        </video>
        <span style="color:black">${time}</span>
      </div>
    `;
  }

  if (msg.message_type === "file") {
    const fileUrl = baseMediaUrl + msg.media_url;
    const filename = msg.media_url.split("/").pop();
    return `
      <div class="message ${isSent ? "sent" : "received"}" id="message-${msg.id}">
        ${deleteBtn}
        ${senderLabel}
        üìé <a href="${fileUrl}" download target="_blank">${filename}</a>
        <span style="color:black">${time}</span>
      </div>
    `;
  }

  return "";
}


async function deleteMessage(messageId, userId) {
  try {
    const response = await fetch(`http://192.168.136.106:8888/delete-message/?message_id=${messageId}&user_id=${userId}`, {
      method: "DELETE"
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail || "Failed to delete message");
    }

    const deletedMessage = await response.json();
    console.log("‚úÖ Deleted:", deletedMessage);

    // Optional: Remove from UI
    document.getElementById(`message-${messageId}`)?.remove();

  } catch (err) {
    console.error("‚ùå Delete failed:", err.message);
  }
}


async function deleteGroupMessage(messageId, senderId) {
  console.log(senderId+"M"+messageId+"");
  try {
    const res = await fetch(`http://192.168.100.29:8888/delete-group-message/?message_id=${messageId}&sender_id=${senderId}`, {
      method: "DELETE"
    });

    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.detail || "Failed to delete group message");
    }

    const deleted = await res.json();
    console.log("‚úÖ Group message deleted:", deleted);

    // Remove from UI
    document.getElementById(`message-${messageId}`)?.remove();
  } catch (err) {
    console.error("‚ùå Delete failed:", err.message);
  }
}

</script>





<script>let chatSocket = null;
 // track current chat
let currentChatId = null;
let currentGroupId = null;
document.getElementById("send-message-button").addEventListener("click", sendMessage);

function sendMessage() {
  const input = document.getElementById("message-input");
  const text=input.value.trim();
  const content = encrypt(text);
  const senderId = parseInt(sessionStorage.getItem("user_id"));

  if (!content) return;

  // Check if group chat is active
  const isGroup = typeof currentGroupId !== "undefined" && currentGroupId !== null;

  const messageData = isGroup
    ? {
        chat_id: currentGroupId,
        sender_id: senderId,
        content: content,
        media_url: "",
        message_type: "text"
      }
    : {
        chat_id: currentChatId,
        sender_id: senderId,
        content: content,
        media_url: "",
        message_type: "text"
      };

  const socketToUse = isGroup ? groupSocket : chatSocket;

  if (!socketToUse || socketToUse.readyState !== WebSocket.OPEN) {
    alert("‚ùå WebSocket not connected.");
    return;
  }

  socketToUse.send(JSON.stringify(messageData));
  input.value = ""; // Clear input after sending
}

async function deleteMessage(messageId, userId) {
  try {
    const response = await fetch(`http://192.168.100.29:8888/delete-message/?message_id=${messageId}&user_id=${userId}`, {
      method: "DELETE"
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail || "Failed to delete message");
    }

    const deletedMessage = await response.json();
    console.log("‚úÖ Deleted:", deletedMessage);

    // Optional: Remove from UI
    document.getElementById(`message-${messageId}`)?.remove();

  } catch (err) {
    console.error("‚ùå Delete failed:", err.message);
  }
}



</script>
//micBtn and file picture send 
<script>
  
</script>
<script>

const uploadUrl = "http://192.168.100.29:8888/upload-media/"; // Global upload endpoint
let mediaRecorder;
let isRecording = false;
let audioChunks = [];

document.getElementById("micBtn").onclick = async () => {
  const micBtn = document.getElementById("micBtn");

  if (!isRecording) {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);

    mediaRecorder.onstop = async () => {
      const blob = new Blob(audioChunks, { type: "audio/webm" });
      const file = new File([blob], "recorded.webm", { type: "audio/webm" });

      const formData = new FormData();
      formData.append("username", sessionStorage.getItem("username"));
      formData.append("file", file);

      try {
        const res = await fetch(uploadUrl, { method: "POST", body: formData });
        const uploadedFileName = await res.text();
        const fileUrl = `${uploadedFileName}`;

        const senderId = parseInt(sessionStorage.getItem("user_id"));
        const isGroup = typeof currentGroupId !== "undefined" && currentGroupId !== null;

        const socketToUse = isGroup ? groupSocket : chatSocket;

        if (!socketToUse || socketToUse.readyState !== WebSocket.OPEN) {
          console.error("‚ùå WebSocket is not open.");
          return;
        }

        const payload = isGroup
          ? {
              group_id: currentGroupId,
              sender_id: senderId,
              content: "",
              media_url: fileUrl,
              message_type: "audio"
            }
          : {
              chat_id: currentChatId,
              sender_id: senderId,
              content: "",
              media_url: fileUrl,
              message_type: "audio"
            };

        socketToUse.send(JSON.stringify(payload));
      } catch (err) {
        console.error("‚ùå Audio upload failed:", err);
      }
    };

    mediaRecorder.start();
    isRecording = true;
    micBtn.classList.add("recording");
    console.log("üéôÔ∏è Recording started...");
  } else {
    mediaRecorder.stop();
    isRecording = false;
    micBtn.classList.remove("recording");
    console.log("üõë Recording stopped.");
  }
};





document.getElementById("fileBtn").onclick = () => {
  document.getElementById("fileInput").click();  // Open file picker
};

document.getElementById("fileInput").onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("username", sessionStorage.getItem("username"));
  formData.append("file", file);

  try {
    const res = await fetch(uploadUrl, { method: "POST", body: formData });
    const uploadedFileName = await res.text(); // e.g. "admin1_20250623_212030.png"
    const fileUrl = `${uploadedFileName}`;

    // Determine message type
    let messageType = "file";
    if (file.type.startsWith("image")) messageType = "photo";
    else if (file.type.startsWith("audio")) messageType = "audio";
    else if (file.type.startsWith("video")) messageType = "video";

    const senderId = parseInt(sessionStorage.getItem("user_id"));
    const isGroup = typeof currentGroupId !== "undefined" && currentGroupId !== null;

    const socketToUse = isGroup ? groupSocket : chatSocket;

    if (!socketToUse || socketToUse.readyState !== WebSocket.OPEN) {
      console.error("‚ùå WebSocket is not open.");
      return;
    }

    const payload = isGroup
      ? {
          chat_id: currentGroupId,
          sender_id: senderId,
          content: "",
          media_url: fileUrl,
          message_type: messageType
        }
      : {
          chat_id: currentChatId,
          sender_id: senderId,
          content: "",
          media_url: fileUrl,
          message_type: messageType
        };

    socketToUse.send(JSON.stringify(payload));
  } catch (err) {
    console.error("‚ùå File upload failed:", err);
  }

  e.target.value = ''; // Reset input
};





</script>
//group socket

<script>


let groupSocket = null;

function openGroupChatSocket(groupId) {
  console.log("open grop chat");
  if (groupSocket) groupSocket.close();

  groupSocket = new WebSocket("ws://192.168.100.29:8888/ws/group_chat");

  groupSocket.onopen = () => console.log("üì° Group WebSocket connected");

  groupSocket.onmessage = (event) => {
    console.log(event.data);
    const msg = JSON.parse(event.data);
    if (msg.chat_id !== groupId) return;

    const container = document.querySelector(".messages");
    container.innerHTML += renderSingleMessage(msg, sessionStorage.getItem("user_id"), true);
  };

  groupSocket.onclose = () => console.log("‚ùå Group WebSocket closed");
  groupSocket.onerror = (e) => console.error("Group WebSocket error", e);
}

function sendGroupMessage(content, media_url = "", type = "text") {
  console.log("sending message send groupgroupmessage");
  const payload = {
    group_id: currentGroupId,
    sender_id: parseInt(sessionStorage.getItem("user_id")),
    content: content,
    media_url: media_url,
    message_type: type
  };

  if (groupSocket && groupSocket.readyState === WebSocket.OPEN) {
    groupSocket.send(JSON.stringify(payload));
  } else {
    console.warn("Group WebSocket not open.");
  }
}
async function deleteGroup(groupId, userId) {
  if (!confirm("Are you sure you want to delete this group?")) return;

  try {
    const res = await fetch(`http://192.168.100.29:8888/delete-group/?group_id=${groupId}&user_id=${userId}`, {
      method: "DELETE"
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || "Failed to delete group");
    }

    const deleted = await res.json();
    console.log("‚úÖ Group deleted:", deleted);

    // Remove the group from the UI
    const allChats = document.querySelectorAll(".chat");
    allChats.forEach(div => {
      if (parseInt(div.dataset.groupId) === groupId) {
        div.remove();
      }
    });
  } catch (err) {
    console.error("‚ùå Delete group failed:", err.message);
    alert("Could not delete group.");
  }
}





</script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
<script>
    const keyHex = "603deb1015ca71be2b73aef0857d77811f352c073b6108d72d9810a30914dff4";
    const ivHex = "000102030405060708090a0b0c0d0e0f";

    const key = CryptoJS.enc.Hex.parse(keyHex);
    const iv = CryptoJS.enc.Hex.parse(ivHex);

    function encrypt(message) {
        const encrypted = CryptoJS.AES.encrypt(message, key, {
            iv: iv,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7
        });
        console.log("Encrypted (Base64):", encrypted.toString());
        return encrypted.toString();
    }

    function decrypt(cipherText) {
      if (!cipherText || typeof cipherText !== "string" || cipherText === "Media") {
      return cipherText; // Don't decrypt "Media", null, or invalid input
    }
        const decrypted = CryptoJS.AES.decrypt(cipherText, key, {
            iv: iv,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7
        });
        const result = decrypted.toString(CryptoJS.enc.Utf8);
        console.log("Decrypted:", result);
        return result;
    }

    // Example usage:
    const encrypted = encrypt("Hello from web!");
    const decrypted = decrypt(encrypted);
</script>
</body>
</html>