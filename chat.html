<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp Web Clone</title>
  <link rel="stylesheet" href="styles.css" />

</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="chat-footer">
        <h1 style="display: inline;">Chats</h1>
        <button id="open-modal" style="margin-left: 330px;width: 30px;height: 30px;border: 4px solid #007bff;">
          <img src="pics/icons8-plus-math-20.png" alt="Send" class="icon" />
        </button>
        <button id="open-settings" style="background:white;width: 30px;height: 30px;  border: 3.5px solid #007bff; right:0">
        <img src="pics/3dotblue.png" alt="Send" class="icon" />
         </button>

      </div>

      <input type="text" placeholder="Search" />
      <!-- Chat list will be injected here -->


   <!-- Chat list gets replaced here -->
<div id="chat-placeholder">
  <div class="chat" onclick="openChat('Umer')">
    <img src="pics/def.jpeg" alt="User" />
    <div>
      <h3>Umer</h3>
      <p>What's going on?</p>
    </div>
    <span>01:00 PM</span>
  </div>
  <div class="chat" onclick="openChat('Ali')">
    <img src="pics/def.jpeg" alt="User" />
    <div>
      <h3>Ali</h3>
      <p>hello</p>
    </div>
    <span>12:20 PM</span>
  </div>
</div>

    </div>

    <!-- Chat Window -->
    <div class="chat-window">
     <div class="chat-header">
  <img src="pics/def.jpeg" alt="User" />
  <div class="user-details">
    <h3 id="chat-name">Umer</h3>
    <div id="chat-status">
      <span class="status-dot">‚óè</span>
      <span class="status-text">Checking...</span>
    </div>
  </div>
</div>

      <div class="messages">
        <div class="message sent">Hello! how are you?<span>12:34</span></div>
        <div class="message received">I'm good, thanks!<span>12:35</span></div>
        <div class="media">
          <img src="pics/uni.jpeg" alt="Video" />
          <audio controls>
            <source src="audio.mp3" type="audio/mpeg" />
          </audio>
        </div>
      </div>
      <div class="chat-footer">
        <button style="background:white;">
          <img src="pics/ios-30 (1).png" alt="Send" class="icon" />
        </button>
        <input type="text" placeholder="Type a message..." />
        <button style="background:rgba(255, 255, 255, 0);">
          <img src="pics/icons8-microphone-30.png" alt="Send" class="icon" />
        </button>
        <button>
          <img src="pics/arrowup.png" alt="Send" class="icon" />
        </button>
      </div>
    </div>
  </div>

  <!-- New contact Modal -->
  <div class="modal" id="new-contact-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>New Contact</h2>
        <button class="close-btn" id="close-contact-modal">&times;</button>
      </div>

      <div class="modal-search">
        <input type="text" placeholder="Search for username" />
      </div>

      <div class="modal-body">
        <div class="section-title">Users available on Aura+</div>
        <ul class="user-list">
          <!-- Repeat user item -->
          <li class="user-item">
            <img src="https://ui-avatars.com/api/?name=John+Doe&background=007bff&color=fff" alt="John Doe" />
            <div class="user-info">
              <h3>John Doe</h3>
              <p>@johndoe</p>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" />
            </div>
          </li>
          <!-- You can duplicate and change names/colors for more users -->
        </ul>
      </div>

      <div class="modal-footer">
        <button id="new-group-modal-button">Create Group</button>
      </div>
    </div>
  </div>

<!-- Modal -->
<div class="modal" id="new-group-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title">New Group</h2>
      <button class="close-btn" id="close-group-modal">&times;</button>
    </div>

    <div class="modal-search">
      <input type="text" placeholder="Search for username" />
    </div>

    <div class="modal-body">
        <div style="margin-bottom: 15px;">
  
  <input id="group-name" type="text" placeholder="Enter Group name" style="width: 88%; padding: 10px; border-radius: 20px; border: 1px solid #ccc; margin-top: 5px;margin-left: 20px;">
</div>
      <div class="section-title">Users available on Aura+</div>
      <ul class="user-list">
        <li class="user-item">
          <img src="https://ui-avatars.com/api/?name=John+Doe&background=007bff&color=fff" alt="John Doe" />
          <div class="user-info">
            <h3>John Doe</h3>
            <p>@johndoe</p>
          </div>
          <div class="checkbox-container">
            <input type="checkbox" class="user-checkbox" />
          </div>
        </li>
        <!-- Duplicate for more users -->
      </ul>
    </div>

    <div class="modal-footer">
      <button id="switch-to-group" onclick="createGroup()">Create Group</button>
    </div>
  </div>
</div>
<!-- Profile  -->

<div class="modal" id="profile-mangment" >
  <div class="modal-content">
    <div class="modal-header">
      <h2>Settings</h2>
      <button class="close-btn" id="close-settings-modal">&times;</button>
    </div>

    <div class="modal-body">
      <div style="padding: 20px;">
        <div onclick="opensettings()" id="profile-card" style="display: flex; align-items: center; background: #f9f9f9; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
  <img id="profile-img" src="pics/def.jpeg" style="width: 60px; height: 60px; border-radius: 50%; margin-right: 15px;" />
  <div>
    <h3 id="profile-name" style="margin: 0; font-size: 18px; color: #3b4a54;">Loading...</h3>
    <p id="profile-username" style="margin: 2px 0 0 0; color: gray;">@username</p>
  </div>
        </div>

        <div style="font-size: 12px; color: gray; text-transform: uppercase; margin-bottom: 8px;">Account</div>

        <div style="border-radius: 12px; overflow: hidden; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
          <div onclick="openChangePasswordModal()" style="display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #eee; cursor: pointer;">
            <img src="pics/key.png" style="width: 24px; height: 24px; background: green; border-radius: 6px; padding: 4px; margin-right: 12px;" />
            <span style="flex-grow: 1; font-weight: 500;">Account</span>
          </div>
          <div style="display: flex; align-items: center; padding: 12px 16px; cursor: pointer;">
            <img src="pics/icons8-warning-sign-66.png" style="width: 24px; height: 24px; background: red; border-radius: 6px; padding: 4px; margin-right: 12px;" />
            <span style="flex-grow: 1; font-weight: 500;">Logout</span>
          </div>
        </div>

      </div>
    </div>
  </div>
<!-- Profile 1  -->
<!-- Settings Edit Modal -->
<div class="modal" id="profile-management-1">
  <div class="modal-content" style="padding: 20px;">
    <div class="modal-header" style="border-bottom: none;">
      <h2>Settings</h2>
      <button class="close-btn" id="profile-management-1-close">&times;</button>
    </div>
    
    <div style="background: #fff; padding: 20px; border-radius: 16px;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <img id="preview-img" src="pics/def.jpeg" alt="Profile" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
        <div>
          <p style="margin: 0; font-size: 15px;">Edit your name and add an optional profile picture</p>
          <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="submitProfileUpdatePhoto(event)" />

          <button onclick="document.getElementById('imageUpload').click()" style="background: none; border: none; color: #007bff; font-weight: 500; padding: 0; cursor: pointer;">Edit</button>
        </div>
      </div>

      <div style="margin-top: 25px;">
        <input id="nameInput" type="text" placeholder="    Enter your name" style=" width: 100%;
    max-width: 400px;
    padding: 10px 15px 10px 40px;
    border: 1px solid #ddd;
    border-radius: 25px;
    color: #3b4a54;
    font-size: 14px;
    outline: none;">
      </div>

      <div style="margin-top: 25px;">
        <button id="confirmProfileUpdate" style="width: 100%; padding: 12px 0; border: none; border-radius: 12px; background: #007bff; color: white; font-size: 16px; font-weight: 500; cursor: pointer;">Confirm</button>
      </div>
    </div>
  </div>
</div>


<!-- Change Password Modal -->
<div class="modal" id="change-password-modal">
  <div class="modal-content" style="padding: 20px;">
    <div class="modal-header" style="border-bottom: none;">
      <h2>Change your Password</h2>
      <button class="close-btn" id="close-password-modal">&times;</button>
    </div>

    <p style="margin-top: -10px; font-size: 14px;">Make sure your password is strong and unique.</p>

    <div style="margin-top: 20px;">
      <label style="font-weight: bold;">Password</label>
      <input type="password" id="old-password" placeholder="Enter your old password" style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc;">
    </div>

    <div style="margin-top: 15px;">
      <label style="font-weight: bold;">New Password</label>
      <input type="password" id="new-password" placeholder="Enter new password" style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc;">
    </div>

    <div style="margin-top: 15px;">
      <label style="font-weight: bold;">Confirm Password</label>
      <input type="password" id="confirm-password" placeholder="Confirm new password" style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc;">
    </div>

    <div style="margin-top: 25px;">
      <button id="submit-password-change" style="width: 100%; padding: 12px 0; border: none; border-radius: 12px; background: #007bff; color: white; font-size: 16px; font-weight: 500; cursor: pointer;">Change Password</button>
    </div>
  </div>
</div>







  <!-- JavaScript -->
  <script>

function openChangePasswordModal() {
  document.getElementById("change-password-modal").style.display = "flex";
}   
// Close modal change password
document.getElementById("close-password-modal").addEventListener("click", function () {
  document.getElementById("change-password-modal").style.display = "none";
});

  function opensettings() {
     document.getElementById('profile-management-1').style.display='flex';
     loadProfileCard()
     
     //document.getElementById("profile-mangment").style.display = "none";
    }

    function openChat(name) {
      document.getElementById("chat-name").textContent = name;
      const chatDiv = Array.from(document.getElementsByClassName("chat"))
    .find(div => div.querySelector("h3")?.textContent === name);

    if (chatDiv) {
    const otherUsername = chatDiv.dataset.username;
    updateHeaderStatus(otherUsername);
  }
    }

    // Modal Show/Hide Logic
  document.getElementById("open-modal").addEventListener("click", function () {
  document.getElementById("new-contact-modal").style.display = "flex"; // ‚úÖ change to flex when opening
  loadContacts();
});


    document.getElementById("close-contact-modal").addEventListener("click", function () {
      document.getElementById("new-contact-modal").style.display = "none";
    });


   // Modal Show/Hide Logic
  document.getElementById("new-group-modal-button").addEventListener("click", function () {
  document.getElementById("new-group-modal").style.display = "flex"; // ‚úÖ change to flex when opening
  document.getElementById("new-contact-modal").style.display = "none";
  loadGroupContacts(); 

});

    document.getElementById("close-group-modal").addEventListener("click", function () {
      document.getElementById("new-group-modal").style.display = "none";
    });





document.getElementById("open-settings").addEventListener("click", () => {
  document.getElementById("profile-mangment").style.display = "flex";
  loadProfileCard();
});




    document.getElementById("close-settings-modal").addEventListener("click", () => {
      document.getElementById("profile-mangment").style.display = "none";
    });
//Call it when tab/window is closed
window.addEventListener("beforeunload", async function () {
  await updateOnlineStatus(false); // mark offline
});


    // Optional: Close modal if clicked outside modal content
   window.onclick = function (event) {
  const modals = document.querySelectorAll(".modal");
  modals.forEach(modal => {
    if (event.target === modal) {
      modal.style.display = "none";
    }
  });
};

document.getElementById("profile-management-1-close").addEventListener("click", function () {
  document.getElementById("profile-management-1").style.display = "none";
});
document.getElementById("submit-password-change").addEventListener("click", function () {
  changePassword();
});
  </script>



<script>
const API_URL_CHATS = "http://192.168.100.196:8888/get_user_chats";
async function changePassword() {
  const username = sessionStorage.getItem("username"); // Ensure username is saved in session
  const oldPassword = document.getElementById("old-password").value.trim();
  const newPassword = document.getElementById("new-password").value.trim();
  const confirmPassword = document.getElementById("confirm-password").value.trim();

  // ‚úÖ Basic validation
  if (!oldPassword || !newPassword || !confirmPassword) {
    alert("‚ö†Ô∏è Please fill in all fields.");
    return;
  }

  if (newPassword !== confirmPassword) {
    alert("‚ùå New password and confirm password do not match.");
    return;
  }

  try {
    const response = await fetch("http://192.168.100.196:8888/update_password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username,
        old_password: oldPassword,
        new_password: newPassword
      })
    });

    const result = await response.json();

    if (!response.ok) throw new Error(result.detail || "Failed to update password.");

    alert("‚úÖ Password changed successfully!");
    document.getElementById("change-password-modal").style.display = "none";

    // Optionally clear fields
    document.getElementById("old-password").value = "";
    document.getElementById("new-password").value = "";
    document.getElementById("confirm-password").value = "";

  } catch (error) {
    console.error("‚ùå Error changing password:", error);
    alert("Error: " + error.message);
  }
}
async function loadChats() {
  const username = sessionStorage.getItem("username"); // or use: sessionStorage.getItem("username");

  if (!username) {
    alert("‚ö†Ô∏è User not logged in.");
    window.location.href = "login.html";
    return;
  }

  try {
    const res = await fetch(API_URL_CHATS, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    if (!res.ok) throw new Error("Failed to fetch chats");

    const chats = await res.json();
    console.log("‚úÖ Chats fetched:", chats);

    const chatList = document.getElementById("chat-placeholder");
    chatList.innerHTML = ""; // clear old chats

    if (!chats.length) {
      chatList.innerHTML = "<p style='padding: 20px;'>No chats available.</p>";
      return;
    }

    chats.forEach(chat => {
      const chatDiv = document.createElement("div");
      chatDiv.className = "chat";
      chatDiv.onclick = () => openChat(chat.with_username);

      // Profile picture
      const imgSrc = chat.profile_picture_base64
        ? chat.profile_picture_base64
        : 'pics/def.jpeg';

      // Time
      let timeText = "";
      if (chat.last_message_time) {
        const dt = new Date(chat.last_message_time);
        timeText = dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      // Chat box HTML
      chatDiv.innerHTML = `
  <img src="${imgSrc}" alt="User" />
  <div>
    <h3>${chat.name}</h3>
    <p>${chat.last_message || ''}</p>
  </div>
  <span>${timeText}</span>
`;

    chatDiv.dataset.chatId = chat.chat_id;
    chatDiv.dataset.userId = chat.with_user_id;
    chatDiv.dataset.username = chat.with_username;


      chatList.appendChild(chatDiv);
    });

  } catch (err) {
    console.error("‚ùå Error loading chats:", err);
    alert("Could not load chats.");
  }
}

async function loadProfileCard() {

  const username = sessionStorage.getItem("username") || "atif"; // fallback for testing

  try {
    const res = await fetch("http://192.168.100.196:8888/get-user-photo", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    if (!res.ok) throw new Error("User not found or no image");

    const data = await res.json();

    // Update profile name and username
    sessionStorage.setItem("name", data.name);
    document.getElementById("profile-name").textContent = data.name;
    document.getElementById("profile-username").textContent = `@${data.username}`;

    // If profile image exists, show it
    if (data.profile_image) {
      document.getElementById("profile-img").src = `data:image/png;base64,${data.profile_image}`;
       sessionStorage.setItem("profile_image", data.profile_image);
    }

  } catch (err) {
    console.warn("‚ö†Ô∏è Could not load profile info:", err);
    document.getElementById("profile-name").textContent = username;
    document.getElementById("profile-username").textContent = `@${username}`;
  }
}
async function submitProfileUpdatePhoto(event) {
  const username = sessionStorage.getItem("username") || "atif"; // replace fallback if needed
  const name = sessionStorage.getItem("name");
 
  const file = event.target.files[0];

  if (!name) {
    
    return;
  }

  if (!file) {
    alert("Please select an image to upload.");
    return;
  }

  try {
    const base64Image = await toBase64(file);

    const res = await fetch("http://192.168.100.196:8888/update-user-photo", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username,
        name,
        profile_image: base64Image.split(",")[1] // remove prefix
      })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Update failed");

    alert("‚úÖ Profile updated successfully.");
    closeEditProfileModal();
    loadProfileCard(); // reload updated info

  } catch (err) {
    console.error("‚ùå Error updating profile:", err);
    alert("Failed to update profile. Try again.");
  }
}

async function handleContactClick(contactUsername) {
  const username = sessionStorage.getItem("username");

  if (!username || !contactUsername || username === contactUsername) {
    alert("‚ùå Invalid contact selection.");
    return;
  }

  try {
    const res = await fetch("http://192.168.100.196:8888/create_or_get_chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username1: username,
        username2: contactUsername
      })
    });

    const data = await res.json();

    if (!res.ok) throw new Error(data.detail || "Failed to create or get chat");

    alert(`‚úÖ Chat ${data.status} (ID: ${data.chat_id})`);
    loadChats(); // Refresh the chat list

  } catch (err) {
    console.error("‚ùå Chat creation error:", err);
    alert("Error creating or getting chat: " + err.message);
  }
}

async function createGroup() {
  const creator = sessionStorage.getItem("username");
  const groupName = document.getElementById("group-name").value.trim();

  // Gather selected users
  const selectedCheckboxes = document.querySelectorAll('#new-group-modal .user-checkbox:checked');
  const selectedUsernames = Array.from(selectedCheckboxes).map(cb => cb.dataset.username);

  // Validation
  if (!groupName) {
    alert("‚ö†Ô∏è Please enter a group name.");
    return;
  }

  if (selectedUsernames.length < 2 || selectedUsernames.length > 5) {
    alert("‚ùå Group must have between 3 and 6 total members including you.");
    return;
  }

  try {
    const res = await fetch("http://192.168.100.196:8888/create_group", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        creator_username: creator,
        group_name: groupName,
        members: selectedUsernames
      })
    });

    const result = await res.json();
    if (!res.ok) throw new Error(result.detail || "Failed to create group");

    alert("‚úÖ Group created successfully!");
    document.getElementById("new-group-modal").style.display = "none";
    loadChats(); // Refresh chat list

  } catch (err) {
    console.error("‚ùå Error creating group:", err);
    alert("Error: " + err.message);
  }
}
async function updateOnlineStatus(isOnline) {
  const username = sessionStorage.getItem("username");
  if (!username) return;

  try {
    await fetch("http://192.168.100.196:8888/update-online-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: username,
        is_online: isOnline
      })
    });
    console.log(`‚ÑπÔ∏è Status updated to ${isOnline ? 'online' : 'offline'}`);
  } catch (err) {
    console.warn("‚ö†Ô∏è Could not update online status:", err);
  }
}
async function updateHeaderStatus(username) {
  try {
    const res = await fetch("http://192.168.100.196:8888/get-online-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Failed");

    const statusText = data.is_online ? "Online" : "Offline";
    const statusColor = data.is_online ? "green" : "gray";

    // Update dot color
    const dot = document.querySelector("#chat-status .status-dot");
    if (dot) dot.style.color = statusColor;

    // Update status text
    const text = document.querySelector("#chat-status .status-text");
    if (text) text.textContent = statusText;

  } catch (err) {
    console.error("‚ùå Cannot fetch online status:", err);
  }
}


// Convert image file to base64 string
function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
    reader.readAsDataURL(file);
  });
}


// Load on window ready
window.onload = loadChats;
</script>
<script>
const API_URL_USERS = "http://192.168.100.196:8888/get-users";

async function loadContacts() {
  const username = sessionStorage.getItem("username"); // Replace with sessionStorage.getItem("username") if needed

  try {
    const res = await fetch(API_URL_USERS, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    if (!res.ok) throw new Error("Failed to fetch users");

    const { users } = await res.json();
    console.log("üì¶ Users fetched:", users);

    const userList = document.querySelector("#new-contact-modal .user-list");
    userList.innerHTML = ""; // Clear existing items

    users.forEach(user => {
      const li = document.createElement("li");
      li.className = "user-item";

      const imgSrc = user.profile_image
        ? `data:image/png;base64,${user.profile_image}`
        : "pics/def.jpeg";

      li.innerHTML = `
        <img src="${imgSrc}" alt="${user.name}" />
        <div class="user-info">
          <h3>${user.name}</h3>
          <p>@${user.username}</p>
        </div>
        <div class="checkbox-container">
    <input type="checkbox" onchange="handleContactClick('${user.username}')" />
  </div>
      `;

      userList.appendChild(li);
    });

  } catch (err) {
    console.error("‚ùå Error fetching contacts:", err);
    alert("Could not load contacts.");
  }
}

</script>
<script>
async function loadGroupContacts() {
  const username = sessionStorage.getItem("username"); // Or use sessionStorage.getItem("username")

  try {
    const res = await fetch("http://192.168.100.196:8888/get-users", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    if (!res.ok) throw new Error("Failed to fetch users");

    const { users } = await res.json();
    console.log("üì¶ Group users fetched:", users);

    const groupList = document.querySelector("#new-group-modal .user-list");
    groupList.innerHTML = ""; // Clear previous

    users.forEach(user => {
      const li = document.createElement("li");
      li.className = "user-item";

      const imgSrc = user.profile_image
        ? `data:image/png;base64,${user.profile_image}`
        : "pics/def.jpeg";

      li.innerHTML = `
        <img src="${imgSrc}" alt="${user.name}" />
        <div class="user-info">
          <h3>${user.name}</h3>
          <p>@${user.username}</p>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" class="user-checkbox" data-username="${user.username}" />
        </div>
      `;

      groupList.appendChild(li);
    });

  } catch (err) {
    console.error("‚ùå Error fetching group contacts:", err);
    alert("Could not load group contacts.");
  }
}
</script>
<script>
let selectedImageBase64 = null; // Global variable

// When file is selected
document.getElementById("imageUpload").addEventListener("change", async function (event) {
  const file = event.target.files[0];
  if (!file) return;

  const base64 = await toBase64(file);
  selectedImageBase64 = base64.split(",")[1]; // remove data:image/png;base64, part

  // Preview the image
  document.getElementById("preview-img").src = base64;
});

// Convert file to base64
function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Confirm click handler
document.getElementById("confirmProfileUpdate").addEventListener("click", async function () {
  const username = sessionStorage.getItem("username") || "guest";
  let name = document.getElementById("nameInput").value.trim();

  // Use old name from session if input is empty
  if (!name) name = sessionStorage.getItem("name") || username;

  try {
    const payload = {
      username,
      name,
      profile_image: selectedImageBase64 // can be null
    };

    const res = await fetch("http://192.168.100.196:8888/update-user-photo", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Failed to update profile");

    alert("‚úÖ Profile updated.");
    sessionStorage.setItem("name", name);
    if (selectedImageBase64) sessionStorage.setItem("profile_image", selectedImageBase64);

    loadProfileCard(); // reload updated profile
    document.getElementById("profile-management-1").style.display = "none";

  } catch (err) {
    console.error("‚ùå Update error:", err);
    alert("Error: " + err.message);
  }
});
</script>


</body>
</html>
